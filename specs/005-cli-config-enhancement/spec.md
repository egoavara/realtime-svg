# Feature Specification: CLI Configuration Enhancement

**Feature Branch**: `005-cli-config-enhancement`  
**Created**: 2025-10-18  
**Status**: Draft  
**Input**: User description: "clap + figment + dotenvy 사용해서 현재 환경변수로만 받는 cli 명령어를 고도화 해. 흐름은 아래와 같아. 1. dotenvy로 .env 파일을 가져옴 2. clap 으로 설정 가져옴, --config {path} 옵션으로 설정파일 위치 지정 가능, 기본은 바이너리 위치의 config.yaml 3. figment 로 설정파일에서 옵션을 받아 옴 동일한 부분을 바꾸는 옵션이 cli, env, config 에 각각 있다면 우선순위는 커멘드라인 옵션 > 환경변수 > 설정파일 이야."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 기본 설정 파일로 서버 실행 (Priority: P1)

운영자가 별도의 인자 없이 서버를 실행하면, 실행 파일 위치의 config.yaml을 자동으로 읽어 서버가 시작된다.

**Why this priority**: 가장 기본적인 사용 사례로, 설정 파일 기반 배포 환경에서 필수적인 기능이다.

**Independent Test**: 바이너리 실행 디렉토리에 config.yaml을 배치한 후 인자 없이 실행하여 설정이 적용되는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** 바이너리 실행 경로에 config.yaml이 존재하고, **When** 운영자가 인자 없이 서버를 실행하면, **Then** config.yaml의 설정값(Redis URL, 포트 등)이 적용되어 서버가 정상 시작된다.
2. **Given** config.yaml이 존재하지 않고, **When** 운영자가 서버를 실행하면, **Then** 기본값으로 서버가 시작된다.
3. **Given** config.yaml이 잘못된 형식이고, **When** 운영자가 서버를 실행하면, **Then** 명확한 오류 메시지가 표시되고 서버가 시작되지 않는다.

---

### User Story 2 - 환경 변수로 설정 오버라이드 (Priority: P1)

운영자가 환경 변수를 설정하면, 설정 파일의 값보다 환경 변수 값이 우선 적용된다.

**Why this priority**: 컨테이너 환경(Docker, Kubernetes)에서 환경 변수를 통한 설정 주입은 표준 패턴이므로 필수적이다.

**Independent Test**: config.yaml과 환경 변수를 모두 설정한 후 서버를 실행하여 환경 변수 값이 우선 적용되는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** config.yaml에 Redis URL이 설정되어 있고, 환경 변수 REDIS_URL이 다른 값으로 설정되어 있으며, **When** 운영자가 서버를 실행하면, **Then** 환경 변수의 Redis URL이 사용된다.
2. **Given** .env 파일에 환경 변수가 정의되어 있고, **When** 운영자가 서버를 실행하면, **Then** .env 파일의 값이 로드되어 적용된다.

---

### User Story 3 - 커맨드라인 옵션으로 최우선 설정 (Priority: P1)

운영자가 커맨드라인 옵션으로 값을 전달하면, 환경 변수와 설정 파일의 값보다 커맨드라인 옵션이 최우선으로 적용된다.

**Why this priority**: 일시적인 테스트나 디버깅 시 설정을 즉시 변경할 수 있는 기능이 필요하므로 필수적이다.

**Independent Test**: 설정 파일, 환경 변수, 커맨드라인 옵션을 모두 다른 값으로 설정한 후 실행하여 커맨드라인 옵션이 최우선 적용되는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** config.yaml과 환경 변수에 Redis URL이 설정되어 있고, **When** 운영자가 --redis-url 옵션으로 다른 값을 전달하면, **Then** 커맨드라인 옵션의 Redis URL이 사용된다.
2. **Given** 기본 설정 상태에서, **When** 운영자가 --port 8080 옵션을 전달하면, **Then** 서버가 8080 포트로 시작된다.

---

### User Story 4 - 커스텀 설정 파일 경로 지정 (Priority: P2)

운영자가 --config 옵션으로 설정 파일 경로를 지정하면, 기본 경로 대신 지정된 경로의 설정 파일이 로드된다.

**Why this priority**: 다중 환경 설정(개발/스테이징/프로덕션)을 유연하게 관리할 수 있게 하는 편의 기능이다.

**Independent Test**: 임의의 경로에 설정 파일을 생성한 후 --config 옵션으로 해당 경로를 지정하여 실행하면 설정이 적용되는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** /etc/app/production.yaml에 프로덕션 설정이 있고, **When** 운영자가 --config /etc/app/production.yaml 옵션으로 서버를 실행하면, **Then** 해당 설정 파일의 값이 적용된다.
2. **Given** 존재하지 않는 경로를 --config로 지정하고, **When** 운영자가 서버를 실행하면, **Then** 명확한 오류 메시지가 표시되고 서버가 시작되지 않는다.

---

### User Story 5 - 설정 검증 및 도움말 (Priority: P3)

운영자가 --help 옵션을 사용하면 모든 사용 가능한 옵션과 설정 항목이 표시되고, 서버 실행 시 설정 검증이 자동으로 수행된다.

**Why this priority**: 사용성과 디버깅을 향상시키는 보조 기능이다.

**Independent Test**: --help 옵션으로 도움말을 확인하고, 잘못된 설정으로 실행하여 검증 로직이 작동하는지 확인할 수 있다.

**Acceptance Scenarios**:

1. **Given** 운영자가 설정 방법을 모르고, **When** --help 옵션을 사용하면, **Then** 모든 커맨드라인 옵션, 환경 변수 이름, 설정 파일 형식이 표시된다.
2. **Given** 잘못된 포트 번호(예: 999999)가 설정되어 있고, **When** 서버를 실행하면, **Then** 유효성 검증 실패 메시지가 표시되고 서버가 시작되지 않는다.

---

### Edge Cases

- 동일한 설정 항목이 세 가지 소스(CLI, ENV, Config)에 모두 다르게 설정된 경우 우선순위 규칙이 명확하게 적용되는가?
- .env 파일과 시스템 환경 변수가 동시에 존재할 때 어떤 것이 우선되는가?
- 설정 파일이 부분적으로만 값을 포함할 때 나머지는 기본값으로 채워지는가?
- 설정 파일 형식이 YAML이 아닌 경우(JSON 등) 어떻게 처리되는가?
- 바이너리 실행 경로와 작업 디렉토리가 다를 때 config.yaml은 어디에서 찾는가?
- 필수 설정 항목이 어디에도 제공되지 않은 경우 기본값 사용 vs 에러 처리 정책은?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 반드시 dotenvy를 사용하여 .env 파일에서 환경 변수를 로드해야 한다.
- **FR-002**: 시스템은 반드시 clap을 사용하여 커맨드라인 인자를 파싱해야 한다.
- **FR-003**: 시스템은 반드시 figment를 사용하여 설정 파일(YAML)에서 설정을 로드해야 한다.
- **FR-004**: 시스템은 반드시 --config 옵션을 제공하여 설정 파일 경로를 지정할 수 있어야 하며, 기본값은 바이너리 실행 경로의 config.yaml이어야 한다.
- **FR-005**: 시스템은 반드시 설정 우선순위를 커맨드라인 옵션 > 환경 변수 > 설정 파일 순서로 적용해야 한다.
- **FR-006**: 시스템은 반드시 Redis URL 설정을 지원해야 한다(현재 환경 변수 REDIS_URL 사용).
- **FR-007**: 시스템은 반드시 서버 바인딩 주소와 포트 설정을 지원해야 한다.
- **FR-008**: 시스템은 반드시 모든 설정 소스에서 동일한 설정 항목을 일관된 이름으로 제공해야 한다.
- **FR-009**: 시스템은 반드시 설정 파일이 존재하지 않거나 형식이 잘못된 경우 명확한 오류 메시지를 제공해야 한다.
- **FR-010**: 시스템은 반드시 --help 옵션으로 모든 사용 가능한 설정 옵션을 표시해야 한다.
- **FR-011**: 시스템은 반드시 설정값 검증을 수행하고 유효하지 않은 값이 있으면 서버 시작을 중단해야 한다.
- **FR-012**: 시스템은 반드시 시작 시 적용된 최종 설정값을 로그로 출력해야 한다(민감 정보는 마스킹).

### Key Entities

- **서버 설정(Server Configuration)**: Redis 연결 정보, 서버 바인딩 주소, 포트, 로깅 레벨 등 애플리케이션 실행에 필요한 모든 설정 항목을 포함하는 구조체.
- **설정 소스(Configuration Source)**: 커맨드라인 옵션, 환경 변수, 설정 파일 세 가지 독립적인 설정 제공 경로. 각 소스는 동일한 설정 스키마를 따르며 우선순위에 따라 병합된다.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 운영자가 설정 파일만으로 서버를 실행할 수 있으며, 설정 변경 후 재실행까지 30초 이내에 완료된다.
- **SC-002**: 운영자가 환경 변수를 통해 설정을 변경하면 재빌드 없이 즉시 적용된다.
- **SC-003**: 운영자가 커맨드라인 옵션으로 일시적 설정 변경 후 서버를 재시작하는 작업이 10초 이내에 완료된다.
- **SC-004**: 설정 오류 발생 시 90% 이상의 경우 오류 원인을 명확히 파악할 수 있는 메시지가 제공된다.
- **SC-005**: 세 가지 설정 소스를 혼합 사용하는 운영자가 우선순위 규칙을 이해하는 데 걸리는 시간이 5분 이내이다(도움말 및 문서 기준).
- **SC-006**: 기존 환경 변수 기반 설정에서 새 시스템으로 마이그레이션하는 데 필요한 코드 변경이 단일 파일 수정으로 완료된다.

## Assumptions

- 설정 파일 형식은 YAML만 지원하며, JSON 등 다른 형식은 현재 범위에 포함하지 않는다.
- .env 파일과 시스템 환경 변수가 동시에 존재할 경우 시스템 환경 변수가 우선된다(dotenvy 기본 동작).
- 설정 파일의 기본 위치는 바이너리 실행 파일과 같은 디렉토리이며, 작업 디렉토리가 아니다.
- 필수 설정 항목(예: Redis URL)이 어디에도 제공되지 않으면 합리적인 기본값(redis://127.0.0.1/)을 사용한다.
- 설정 검증은 타입 검증과 범위 검증(예: 포트 1-65535)을 포함한다.
- 민감 정보(비밀번호, 토큰)는 로그에 출력하지 않거나 마스킹 처리한다.

## Out of Scope

- 설정 파일 암호화 기능
- 런타임 중 설정 핫 리로드(서버 재시작 필요)
- 설정 변경 이력 추적
- 여러 설정 파일 동시 병합(단일 파일만 지원)
- GUI 기반 설정 편집기
