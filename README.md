# realtime-svg

ì‹¤ì‹œê°„ SVG ìŠ¤íŠ¸ë¦¬ë° ì„œë²„ with JWT ì¸ì¦

## ê°œìš”

`multipart/x-mixed-replace` í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ SVG ì´ë¯¸ì§€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì— ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ” Rust ê¸°ë°˜ ì„œë²„ì…ë‹ˆë‹¤. Tera í…œí”Œë¦¿ ì—”ì§„ìœ¼ë¡œ ë™ì  SVGë¥¼ ìƒì„±í•˜ê³ , Redisë¥¼ í†µí•´ ì‹¤ì‹œê°„ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ë¥¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•©ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥:**
- ğŸ” JWT ê¸°ë°˜ ì‚¬ìš©ì ì¸ì¦ (RSA-2048)
- ğŸ‘¤ ì‚¬ìš©ìë³„ ì„¸ì…˜ ê´€ë¦¬ ë° ì†Œìœ ê¶Œ ì œì–´
- ğŸ“¡ ì‹¤ì‹œê°„ SVG ìŠ¤íŠ¸ë¦¬ë° (`multipart/x-mixed-replace`)
- ğŸ¨ Tera í…œí”Œë¦¿ ê¸°ë°˜ ë™ì  SVG ìƒì„±
- ğŸš€ Redis pubsubì„ í†µí•œ ì‹¤ì‹œê°„ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- ğŸ”„ ê¸°ì¡´ ê³µìš© ì„¸ì…˜ API ì™„ì „ í˜¸í™˜

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Backend    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Redis  â”‚
â”‚             â”‚  Stream  â”‚   (Axum)     â”‚  pubsub  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                        â”‚                       â”‚
       â”‚ 1. POST /api/auth/token                      â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  (JWT issued)        â”‚
       â”‚ {"token": "..."}       â”‚                       â”‚
       â”‚                        â”‚                       â”‚
       â”‚ 2. POST /api/user/{user_id}/session          â”‚
       â”‚    Authorization: Bearer <token>              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
       â”‚                        â”‚  SET user:alice:...   â”‚
       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                       â”‚
       â”‚ {"session_id": "..."}  â”‚                       â”‚
       â”‚                        â”‚                       â”‚
       â”‚ 3. GET /stream/{user_id}/{session_id}        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
       â”‚                        â”‚  SUBSCRIBE ...        â”‚
       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                       â”‚
       â”‚   SVG Stream (live)    â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
       â”‚                        â”‚  (pubsub updates)     â”‚
       â”‚                        â”‚                       â”‚
       â”‚ 4. PUT /api/user/{user_id}/session/{id}      â”‚
       â”‚    Authorization: Bearer <token>              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
       â”‚                        â”‚  PUBLISH update       â”‚
       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                        â”‚                       â”‚
       â”‚   (All connected clients get updated SVG)     â”‚
       â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## JWT ì¸ì¦ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                 â”‚  Server  â”‚                 â”‚  Redis  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                            â”‚                            â”‚
     â”‚ POST /api/auth/token       â”‚                            â”‚
     â”‚ {"user_id": "alice"}       â”‚                            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
     â”‚                            â”‚ GET rsa:private_pem        â”‚
     â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                            â”‚ (JwkCache: first load)     â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚ Sign JWT with RSA key      â”‚
     â”‚                            â”‚ {sub: "alice",             â”‚
     â”‚                            â”‚  exp: now + 24h,           â”‚
     â”‚                            â”‚  iss: "realtime-svg"}      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚ {"token": "eyJhbG..."}     â”‚                            â”‚
     â”‚                            â”‚                            â”‚
     â”‚ POST /api/user/alice/session                           â”‚
     â”‚ Authorization: Bearer eyJ...                            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
     â”‚                            â”‚ GET rsa:public_pem         â”‚
     â”‚                            â”‚ (cached in JwkCache)       â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚ Verify signature âœ“         â”‚
     â”‚                            â”‚ Check exp > now âœ“          â”‚
     â”‚                            â”‚ Check iss == "realtime-svg"âœ“
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚ Extract sub = "alice"      â”‚
     â”‚                            â”‚ Match URL user_id âœ“        â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚ SET user:alice:session:... â”‚
     â”‚                            â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚ 201 Created                â”‚                            â”‚
     â”‚                            â”‚                            â”‚
```

## ë¹ ë¥¸ ì‹œì‘

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­

- Rust 1.75+
- Redis ì„œë²„

### ì„¤ì¹˜ ë° ì‹¤í–‰

```bash
# 1. Redis ì‹¤í–‰
redis-server

# 2. í”„ë¡œì íŠ¸ ë¹Œë“œ
cargo build --release

# 3. ì„œë²„ ì‹¤í–‰
cargo run --bin backend

# Server listening on http://0.0.0.0:3000
```

### ì‚¬ìš© ì˜ˆì œ

#### 1. JWT í† í° ë°œê¸‰

```bash
curl -X POST http://localhost:3000/api/auth/token \
  -H "Content-Type: application/json" \
  -d '{"user_id": "alice", "password": "your-password"}'

# Response: {"token": "eyJhbGciOiJSUzI1NiIs..."}
```

#### 2. ì‚¬ìš©ì ì„¸ì…˜ ìƒì„±

```bash
export TOKEN="eyJhbGciOiJSUzI1NiIs..."

curl -X POST http://localhost:3000/api/user/alice/session \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "session_id": "dashboard-1",
    "template": "<svg><text fill=\"{{color}}\">{{status}}</text></svg>",
    "args": {"status": "online", "color": "green"}
  }'
```

#### 3. ë¸Œë¼ìš°ì €ì—ì„œ ìŠ¤íŠ¸ë¦¼ ë³´ê¸°

```
http://localhost:3000/stream/alice/dashboard-1
```

#### 4. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

```bash
curl -X PUT http://localhost:3000/api/user/alice/session/dashboard-1 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"args": {"status": "offline", "color": "red"}}'
```

â†’ ëª¨ë“  ì—°ê²°ëœ ë¸Œë¼ìš°ì €ê°€ ì¦‰ì‹œ ë¹¨ê°„ìƒ‰ "offline" ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.

## API ë¬¸ì„œ

### ì¸ì¦ API

#### `POST /api/auth/token`
JWT í† í° ë°œê¸‰

**Request:**
```json
{
  "user_id": "alice",
  "password": "your-password",
  "ttl_seconds": 86400  // optional, default: 3600 seconds
}
```

**Response:**
```json
{
  "token": "eyJhbGciOiJSUzI1NiIs..."
}
```

#### `GET /.well-known/jwks.json`
JWK ê³µê°œ í‚¤ ì¡°íšŒ (RFC 8414)

**Response:**
```json
{
  "keys": [
    {
      "kty": "RSA",
      "n": "xGOr...",
      "e": "AQAB",
      "alg": "RS256",
      "use": "sig"
    }
  ]
}
```

### ì‚¬ìš©ì ì„¸ì…˜ API

#### `POST /api/user/{user_id}/session`
ì‚¬ìš©ì ì„¸ì…˜ ìƒì„± (JWT í•„ìš”)

**Headers:**
- `Authorization: Bearer <token>`

**Request:**
```json
{
  "session_id": "dashboard-1",
  "template": "<svg>...</svg>",
  "args": {"key": "value"}
}
```

#### `PUT /api/user/{user_id}/session/{session_id}`
ì„¸ì…˜ íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ (ì†Œìœ ìë§Œ ê°€ëŠ¥)

**Headers:**
- `Authorization: Bearer <token>`

**Request:**
```json
{
  "args": {"status": "updated"}
}
```

#### `GET /api/user/{user_id}/session`
ì‚¬ìš©ì ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ

**Headers:**
- `Authorization: Bearer <token>`

**Response:**
```json
{
  "items": [
    {
      "session_id": "dashboard-1"
    }
  ]
}
```

#### `GET /stream/{user_id}/{session_id}`
ì‹¤ì‹œê°„ SVG ìŠ¤íŠ¸ë¦¼ (ì¸ì¦ ë¶ˆí•„ìš”)

**Response:**
```
Content-Type: multipart/x-mixed-replace; boundary=frame

--frame
Content-Type: image/svg+xml

<svg>...</svg>
--frame
...
```

### ê³µìš© ì„¸ì…˜ API (í•˜ìœ„ í˜¸í™˜)

ê¸°ì¡´ ì¸ì¦ ì—†ëŠ” ì„¸ì…˜ì€ ê³„ì† ì§€ì›ë©ë‹ˆë‹¤:

- `POST /api/session`
- `PUT /api/session/{session_id}`
- `GET /stream/{session_id}`

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
realtime-svg/
â”œâ”€â”€ crates/
â”‚   â”œâ”€â”€ common/          # ê³µí†µ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ jwt.rs       # JWT ìƒì„±/ê²€ì¦
â”‚   â”‚   â”œâ”€â”€ jwk.rs       # JWK ê´€ë¦¬ ë° ìºì‹±
â”‚   â”‚   â”œâ”€â”€ auth.rs      # AuthenticatedUser extractor
â”‚   â”‚   â”œâ”€â”€ state.rs     # AppState (Redis, JwkCache)
â”‚   â”‚   â””â”€â”€ session_data.rs  # SessionData ëª¨ë¸
â”‚   â”œâ”€â”€ backend/         # HTTP ì„œë²„
â”‚   â”‚   â”œâ”€â”€ route/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/    # JWT ë°œê¸‰ API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user/    # ì‚¬ìš©ì ì„¸ì…˜ API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ session/ # ê³µìš© ì„¸ì…˜ API
â”‚   â”‚   â”‚   â””â”€â”€ stream/      # ìŠ¤íŠ¸ë¦¼ ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â””â”€â”€ tests/       # í†µí•© í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ frontend/        # Yew WASM ì›¹ í´ë¼ì´ì–¸íŠ¸
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ components/  # UI ì»´í¬ë„ŒíŠ¸
â”‚       â”‚   â”œâ”€â”€ api/         # API í´ë¼ì´ì–¸íŠ¸
â”‚       â”‚   â””â”€â”€ auth/        # JWT ì¸ì¦ ë¡œì§
â”‚       â””â”€â”€ styles.css   # ë‹¤í¬ í…Œë§ˆ ìŠ¤íƒ€ì¼
â””â”€â”€ specs/               # ê¸°ëŠ¥ ëª…ì„¸ì„œ
    â””â”€â”€ 002-user-session-auth/
        â”œâ”€â”€ spec.md      # ìš”êµ¬ì‚¬í•­ ëª…ì„¸
        â”œâ”€â”€ plan.md      # ê¸°ìˆ  ì„¤ê³„
        â”œâ”€â”€ tasks.md     # êµ¬í˜„ íƒœìŠ¤í¬
        â””â”€â”€ contracts/   # API ê³„ì•½
```

## ê¸°ìˆ  ìŠ¤íƒ

### ë°±ì—”ë“œ
- **ì–¸ì–´:** Rust 2021
- **ì›¹ í”„ë ˆì„ì›Œí¬:** Axum 0.8
- **í…œí”Œë¦¿:** Tera
- **ì¸ì¦:** jsonwebtoken 10 (RS256)
- **ìŠ¤í† ë¦¬ì§€:** Redis 7+
- **ë¹Œë“œ:** Cargo workspace

### í”„ë¡ íŠ¸ì—”ë“œ
- **í”„ë ˆì„ì›Œí¬:** Yew 0.21 (Rust WASM)
- **ë¼ìš°íŒ…:** yew-router 0.18
- **HTTP í´ë¼ì´ì–¸íŠ¸:** gloo-net 0.4
- **ë¹Œë“œ:** Trunk
- **ìŠ¤íƒ€ì¼:** ì»¤ìŠ¤í…€ CSS (ë‹¤í¬ í…Œë§ˆ)

## ë³´ì•ˆ

### JWT í‚¤ ê´€ë¦¬

- **ì•Œê³ ë¦¬ì¦˜:** RSA-2048 with SHA-256 (RS256)
- **í‚¤ ìƒì„±:** ì„œë²„ ì‹œì‘ ì‹œ ìë™ ìƒì„± (ì—†ëŠ” ê²½ìš°)
- **ì €ì¥ì†Œ:** Redis (`rsa:private_pem`, `rsa:public_pem`)
- **ìºì‹±:** ë©”ëª¨ë¦¬ ìºì‹œ (OnceCell)ë¡œ ì„±ëŠ¥ ìµœì í™”
- **ì›ìì„±:** Redis `SET NX`ë¡œ ë™ì‹œ ìƒì„± ë°©ì§€

### ê¶Œí•œ ëª¨ë¸

- ì„¸ì…˜ **ì½ê¸°**: ì¸ì¦ ë¶ˆí•„ìš” (ê³µê°œ)
- ì„¸ì…˜ **ì“°ê¸°**: JWT ì¸ì¦ + ì†Œìœ ì ê²€ì¦ í•„ìš”
- í† í° ê²€ì¦ ì‹¤íŒ¨: 401 Unauthorized
- ì†Œìœ ì ë¶ˆì¼ì¹˜: 403 Forbidden

## í…ŒìŠ¤íŠ¸

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
cargo test

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
cargo test jwt_flow
cargo test user_session

# í†µí•© í…ŒìŠ¤íŠ¸ (Redis í•„ìš”)
cargo test --test us1_session_creation_test
cargo test --test us2_authorization_test
```

**í…ŒìŠ¤íŠ¸ í˜„í™©:** âœ… 26ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼

## ì„±ëŠ¥

- **JWT ê²€ì¦:** < 50ms (ë©”ëª¨ë¦¬ ìºì‹œ ì‚¬ìš©)
- **í† í° ë°œê¸‰:** < 1ì´ˆ
- **JWK ì´ˆê¸°í™”:** < 5ì´ˆ
- **ì„¸ì…˜ ìš©ëŸ‰:** ì‚¬ìš©ìë‹¹ 100+ ì„¸ì…˜ ì§€ì›

## ë¼ì´ì„ ìŠ¤

MIT License

## ê¸°ì—¬

Issue ë° PRì€ ì–¸ì œë‚˜ í™˜ì˜í•©ë‹ˆë‹¤!

## ì°¸ê³  ë¬¸ì„œ

- [ê¸°ëŠ¥ ëª…ì„¸ì„œ](./specs/002-user-session-auth/spec.md)
- [ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ](./specs/002-user-session-auth/quickstart.md)
- [API ê³„ì•½](./specs/002-user-session-auth/contracts/)
